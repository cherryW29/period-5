<!DOCTYPE html>
<html>
  <head> 
    <meta charset="utf-8">
    <title>Shooting Gallery</title>
    <meta name="description" content="CTE Shooting Gallery">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="constants.js"></script>
    <script src="fire.js"></script>
    <script src="clickOnBox.js"></script>
    <script src="lookingAtBox.js"></script>
    <script src="notLookingAtBox.js"></script>
    <script src="boxSpin.js"></script>
    <script src="collide.js"></script>
    <script src="https://unpkg.com/aframe-aabb-collider-component/dist/aframe-aabb-collider-component.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.1/dist/aframe-environment-component.min.js"></script>
  </head>
  <body>

    <!-- Main scene definition -->
    <a-scene id="scene">
      <a-assets>
        <audio id="music" src="egypt-egyptian-desert-music-263086.mp3" preload="auto"></audio>
      </a-assets>
      
      <!-- Background Music - will start after user interaction -->
      <a-entity id="backgroundMusic" sound="src: #music; loop: true; autoplay: false"></a-entity>
      <!-- scoreboard -->
      <a-text id="scoreText"
        value="Score: 0"
        position="-1.8 1.8 -3"
        scale="1.5 1.5 1.5"
        color="#FFF"
        font="kelsonsans"></a-text>
      <a-text id="highText"
        value="Best: 0"
        position="-1.8 1.5 -3"
        scale="1 1 1"
        color="#FFD"></a-text>
      <!-- Environment preset -->
      <a-entity environment="preset:egypt"></a-entity>
      <a-entity box-spin looking-at-box not-looking-at-box
            id="box" 
            geometry="primitive:cone; radiusBottom:0.7; radiusTop:0; segmentsRadial:4"
            position="0 3 -5"
            class = "clickable detect-collide"
            material="color: blue; src: https://raw.githubusercontent.com/Leo-P78/VR-Shooter-Prunty-Peng/refs/heads/main/assets/brickPattern.jpg">
      </a-entity>

      <a-entity light = "type:ambient ;color:white;"
        location = "0 0 -1"></a-entity>
      <a-entity camera
                look-controls
                id="camera"
                position="0 1.5 0"
                rotation="0 0 0">
        
        <a-entity raycaster="objects: .clickable; far:1000">
        </a-entity>
        <a-entity cursor click-on-box
                  position="0 0 -1.5"
                  geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
                  material="color: red; shader: flat">
        </a-entity>
        <a-entity fire collide
              id="torpedo"
              geometry="primitive:sphere; radius:0.2"
              material="color:white; opacity:1"
              position="0 0 -1"
              visible="false"
              aabb-collider="objects: .detect-collide; watch: true">
        </a-entity>
      </a-entity>
    </a-scene>
    
    <script>
      // Start music after user interaction (required by browser autoplay policy)
      let musicStarted = false;
      function startMusic() {
        if (!musicStarted) {
          musicStarted = true;
          let musicEntity = document.getElementById('backgroundMusic');
          let scene = document.querySelector('a-scene');
          
          if (musicEntity && scene) {
            // Resume AudioContext if suspended
            function playMusic() {
              if (musicEntity.components && musicEntity.components.sound) {
                let soundComponent = musicEntity.components.sound;
                if (typeof soundComponent.playSound === 'function') {
                  soundComponent.playSound();
                } else {
                  musicEntity.setAttribute('sound', 'autoplay', true);
                }
              } else {
                setTimeout(function() {
                  if (musicEntity.components && musicEntity.components.sound) {
                    musicEntity.setAttribute('sound', 'autoplay', true);
                  }
                }, 100);
              }
            }
            
            if (scene.audioContext) {
              if (scene.audioContext.state === 'suspended') {
                scene.audioContext.resume().then(playMusic).catch(playMusic);
              } else {
                playMusic();
              }
            } else {
              setTimeout(function() {
                if (scene.audioContext && scene.audioContext.state === 'suspended') {
                  scene.audioContext.resume().then(playMusic).catch(playMusic);
                } else {
                  playMusic();
                }
              }, 100);
            }
          }
        }
      }
      
      // Listen for user interactions
      let scene = document.querySelector('a-scene');
      function setupMusicListeners() {
        document.addEventListener('click', startMusic, {once: true});
        document.addEventListener('mousedown', startMusic, {once: true});
        document.addEventListener('touchstart', startMusic, {once: true});
        document.addEventListener('keydown', startMusic, {once: true});
      }
      
      if (scene.hasLoaded) {
        setupMusicListeners();
      } else {
        scene.addEventListener('loaded', setupMusicListeners);
      }
    </script>
    
  </body>
</html>
